{
  "dry_run": false,
  "steps": [
    { "type":"write_files", "files": {
      "src/ServerScriptService/Net/RateLimiter.lua": {
        "encoding":"utf8",
        "content":"local RateLimiter = {}\n\nlocal DEFAULT_LIMITS = { calls = 10, per = 1 } -- 10 calls per second\nlocal buckets = {} -- [key][name] = {calls, windowStart}\n\nfunction RateLimiter:getKey(player)\n\treturn player and (\"p:\" .. player.UserId) or \"server\"\nend\n\nfunction RateLimiter:allowed(key, name, limits)\n\tlimits = limits or DEFAULT_LIMITS\n\tlocal now = time()\n\tbuckets[key] = buckets[key] or {}\n\tlocal b = buckets[key][name]\n\tif not b or now - b.windowStart >= limits.per then\n\t\tb = { calls = 0, windowStart = now }\n\t\tbuckets[key][name] = b\n\tend\n\tif b.calls < limits.calls then\n\t\tb.calls = b.calls + 1\n\t\treturn true\n\telse\n\t\treturn false\n\tend\nend\n\nreturn RateLimiter\n"
      },
      "src/ServerScriptService/Net/InitRemotes.server.lua": {
        "encoding":"utf8",
        "content":"local ReplicatedStorage = game:GetService(\"ReplicatedStorage\")\nlocal RateLimiter = require(script.Parent.RateLimiter)\n\nlocal remotesFolder = ReplicatedStorage:FindFirstChild(\"Remotes\") or Instance.new(\"Folder\")\nremotesFolder.Name = \"Remotes\"\nremotesFolder.Parent = ReplicatedStorage\n\nlocal function getOrCreateRemote(name, className)\n\tlocal r = remotesFolder:FindFirstChild(name)\n\tif not r then\n\t\tr = Instance.new(className)\n\t\tr.Name = name\n\t\tr.Parent = remotesFolder\n\tend\n\treturn r\nend\n\nlocal ClientPing = getOrCreateRemote(\"ClientPing\",\"RemoteFunction\")\nlocal RequestJoin = getOrCreateRemote(\"RequestJoin\",\"RemoteFunction\")\nlocal KickBall = getOrCreateRemote(\"KickBall\",\"RemoteEvent\")\n\nClientPing.OnServerInvoke = function(player, payload)\n\tif not RateLimiter:allowed(RateLimiter:getKey(player),\"ClientPing\",{calls=3, per=1}) then\n\t\treturn { ok=false, err=\"rate_limited\" }\n\tend\n\treturn { ok=true, serverTime=time(), echo=payload }\nend\n\nRequestJoin.OnServerInvoke = function(player)\n\tif not RateLimiter:allowed(RateLimiter:getKey(player),\"RequestJoin\",{calls=2, per=5}) then\n\t\treturn { ok=false, err=\"rate_limited\" }\n\tend\n\treturn { ok=true }\nend\n\nKickBall.OnServerEvent:Connect(function(player, impulse)\n\tif not RateLimiter:allowed(RateLimiter:getKey(player),\"KickBall\",{calls=4, per=1}) then\n\t\treturn\n\tend\n\t-- server-side physics will apply kick later\nend)\n\nprint(\"[Net] Remotes initialized.\")\n"
      },
      "src/ServerScriptService/Match/MatchManager.server.lua": {
        "encoding":"utf8",
        "content":"local ReplicatedStorage = game:GetService(\"ReplicatedStorage\")\n\nlocal REMOTES = ReplicatedStorage:FindFirstChild(\"Remotes\") or Instance.new(\"Folder\")\nREMOTES.Name = \"Remotes\"; REMOTES.Parent = ReplicatedStorage\n\nlocal MatchStateChanged = REMOTES:FindFirstChild(\"MatchStateChanged\") or Instance.new(\"RemoteEvent\")\nMatchStateChanged.Name = \"MatchStateChanged\"; MatchStateChanged.Parent = REMOTES\n\nlocal StateFolder = ReplicatedStorage:FindFirstChild(\"MatchState\") or Instance.new(\"Folder\")\nStateFolder.Name = \"MatchState\"; StateFolder.Parent = ReplicatedStorage\n\nlocal function getValue(name, class, initial)\n\tlocal v = StateFolder:FindFirstChild(name)\n\tif not v then\n\t\tv = Instance.new(class)\n\t\tv.Name = name\n\t\tif class == \"IntValue\" then v.Value = initial or 0 end\n\t\tif class == \"StringValue\" then v.Value = initial or \"Init\" end\n\t\tStateFolder[name] = v; v.Parent = StateFolder\n\tend\n\treturn v\nend\n\nlocal TimeLeft = getValue(\"TimeLeft\",\"IntValue\", 180) -- 3 minutes\nlocal HomeScore = getValue(\"HomeScore\",\"IntValue\", 0)\nlocal AwayScore = getValue(\"AwayScore\",\"IntValue\", 0)\nlocal Phase = getValue(\"Phase\",\"StringValue\", \"Init\")\n\nlocal running = false\n\nlocal function setPhase(p)\n\tPhase.Value = p\n\tMatchStateChanged:FireAllClients({ phase = p, timeLeft = TimeLeft.Value, home = HomeScore.Value, away = AwayScore.Value })\n\tprint(\"[Match] Phase:\", p)\nend\n\nlocal function start()\n\trunning = true\n\tsetPhase(\"Playing\")\n\twhile running do\n\t\tif TimeLeft.Value > 0 then\n\t\t\tTimeLeft.Value -= 1\n\t\t\tif TimeLeft.Value % 10 == 0 then\n\t\t\t\tMatchStateChanged:FireAllClients({ phase = Phase.Value, timeLeft = TimeLeft.Value })\n\t\t\t\tprint(\"[Match] TimeLeft:\", TimeLeft.Value)\n\t\t\tend\n\t\t\ttask.wait(1)\n\t\telse\n\t\t\tsetPhase(\"Finished\")\n\t\t\trunning = false\n\t\tend\n\tend\nend\n\n-- Autostart shortly after server boot\ntask.spawn(function()\n\ttask.wait(2)\n\tstart()\nend)\n"
      }
    }},
    { "type":"validate", "checks": [
      { "op":"text_contains", "path":"src/ServerScriptService/Net/RateLimiter.lua", "substr":"now = time()" },
      { "op":"text_contains", "path":"src/ServerScriptService/Net/InitRemotes.server.lua", "substr":"serverTime=time()" },
      { "op":"text_contains", "path":"src/ServerScriptService/Match/MatchManager.server.lua", "substr":"task.wait(1)" },
      { "op":"text_contains", "path":"src/ServerScriptService/Match/MatchManager.server.lua", "substr":"task.spawn" }
    ]}
  ]
}
