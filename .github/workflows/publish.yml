name: Publish
on:
  workflow_dispatch:
    inputs:
      channel:
        description: "dry (build only) or live (build + publish)"
        required: false
        default: "dry"
  push:
    tags: ['v*']  # tag v0.1.0 to live publish

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions: { contents: read }
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          set -euxo pipefail
          sudo apt-get update -y
          sudo apt-get install -y unzip jq curl tar

      - name: Install Rojo (auto-detect asset)
        run: |
          set -euxo pipefail
          # Try preferred pattern, then fallbacks
          ROJO_URL=$(
            curl -fsSL https://api.github.com/repos/rojo-rbx/rojo/releases/latest \
            | jq -r '
                .assets[]
                | select(.name|test("linux-x86_64\\.zip$"))
                | .browser_download_url
              ' | head -n1
          )
          if [ -z "$ROJO_URL" ]; then
            ROJO_URL=$(
              curl -fsSL https://api.github.com/repos/rojo-rbx/rojo/releases/latest \
              | jq -r '
                  .assets[]
                  | select(.name|test("linux.*\\.zip$") and (test("aarch|arm")==false))
                  | .browser_download_url
                ' | head -n1
            )
          fi
          echo "Rojo URL: ${ROJO_URL}"
          test -n "$ROJO_URL"
          TMP="$(mktemp -d)"; cd "$TMP"
          curl -fsSL -o rojo.zip "$ROJO_URL"
          unzip -o rojo.zip
          ROJO_BIN="$(find . -type f -name rojo -perm -u+x | head -n1)"
          sudo install -m 755 "$ROJO_BIN" /usr/local/bin/rojo
          rojo --version

      - name: Install rbxcloud (auto-detect asset)
        run: |
          set -euxo pipefail
          RBC_URL=$(
            curl -fsSL https://api.github.com/repos/Sleitnick/rbxcloud/releases/latest \
            | jq -r '
                .assets[]
                | select(.name|test("linux.*(x86_64|amd64).*(zip|tar\\.gz)$"))
                | .browser_download_url
              ' | head -n1
          )
          echo "rbxcloud URL: ${RBC_URL}"
          test -n "$RBC_URL"
          TMP="$(mktemp -d)"; cd "$TMP"
          curl -fsSL -o rbc.file "$RBC_URL"
          case "$RBC_URL" in
            *.zip) unzip -o rbc.file ;;
            *.tar.gz) tar -xzf rbc.file ;;
            *) echo "Unknown rbxcloud archive format" >&2; exit 1 ;;
          esac
          RBC_BIN="$(find . -type f -name rbxcloud -perm -u+x | head -n1)"
          sudo install -m 755 "$RBC_BIN" /usr/local/bin/rbxcloud
          rbxcloud --version

      - name: Build place
        run: |
          set -euxo pipefail
          mkdir -p build
          rojo build -o build/RobloxSoccer.rbxlx

      - name: Publish to Roblox (Open Cloud)
        if: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.channel == 'live') || startsWith(github.ref, 'refs/tags/v') }}
        env:
          ROBLOX_API_KEY: ${{ secrets.ROBLOX_API_KEY }}
          UNIVERSE_ID: ${{ vars.UNIVERSE_ID }}
          PLACE_ID: ${{ vars.PLACE_ID }}
        run: |
          set -euxo pipefail
          rbxcloud experience publish \
            --api-key "$ROBLOX_API_KEY" \
            --universe-id "$UNIVERSE_ID" \
            --place-id "$PLACE_ID" \
            --file "build/RobloxSoccer.rbxlx" \
            --universe-asset-type Place \
            --publish-policy Latest

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: place
          path: build/RobloxSoccer.rbxlx
