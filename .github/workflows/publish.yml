name: Publish

on:
  workflow_dispatch:
    inputs:
      channel:
        description: "dry or live"
        required: false
        default: "live"
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: read

env:
  UNIVERSE_ID: ${{ vars.UNIVERSE_ID }}
  PLACE_ID:    ${{ vars.PLACE_ID }}

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          set -euxo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq curl unzip

      - name: Install Rojo (latest)
        run: |
          set -euxo pipefail
          ROJO_VERSION=7.6.1
          curl -fsSL -o rojo.zip "https://github.com/rojo-rbx/rojo/releases/download/v${ROJO_VERSION}/rojo-${ROJO_VERSION}-linux-x86_64.zip"
          sudo unzip -o rojo.zip -d /usr/local/bin
          sudo chmod +x /usr/local/bin/rojo
          rojo --version

      # Keep this sanity check light: confirm the PLACE maps to the same UNIVERSE.
      - name: Sanity check (IDs only)
        if: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.channel == 'live') || startsWith(github.ref, 'refs/tags/v') }}
        env:
          ROBLOX_API_KEY: ${{ secrets.ROBLOX_API_KEY }}
        run: |
          set -euxo pipefail
          echo "UNIVERSE_ID=${UNIVERSE_ID}  PLACE_ID=${PLACE_ID}"
          CODE=$(curl -sS -o /tmp/u.json -w "%{http_code}" \
            -H "x-api-key: ${ROBLOX_API_KEY}" -H "Accept: application/json" \
            "https://apis.roblox.com/universes/v1/places/${PLACE_ID}/universe")
          test "$CODE" = "200"
          REAL_UID=$(jq -r .universeId /tmp/u.json)
          echo "REAL_UNIVERSE_ID=${REAL_UID}"
          test "$REAL_UID" = "$UNIVERSE_ID"

            - name: Build place
        run: |
          mkdir -p build
          rojo build -o build/RobloxSoccer.rbxlx

      - name: Publish to Roblox (Open Cloud via HTTP, with retries)
        if: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.channel == 'live') || startsWith(github.ref, 'refs/tags/v') }}
        env:
          ROBLOX_API_KEY: ${{ secrets.ROBLOX_API_KEY }}
        run: |
          set -u  # no -e here; we handle errors manually for retries

          URL="https://apis.roblox.com/universes/v1/${UNIVERSE_ID}/places/${PLACE_ID}/versions?versionType=Published&versionDescription=ci:${GITHUB_SHA::7}"

          attempt=1
          max=6
          backoff=4

          while [ $attempt -le $max ]; do
            echo "Attempt $attempt/$max"

            HTTP_CODE=$(curl -sS -o /tmp/resp.json -w '%{http_code}' -X POST "$URL" \
              -H "x-api-key: ${ROBLOX_API_KEY}" \
              -H "Accept: application/json" \
              -H "User-Agent: rbxcloud/ci" \
              -H "RBX-Source: GitHubActions" \
              -H "Content-Type: application/octet-stream" \
              --data-binary @build/RobloxSoccer.rbxlx || echo "000")

            echo "HTTP $HTTP_CODE"
            cat /tmp/resp.json || true

            # Success: 200 OK or 202 Accepted
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "202" ]; then
              exit 0
            fi

            # Known transient buckets: 000 transport, 409 conflict, 429 too many, or any 5xx
            if [ "$HTTP_CODE" = "000" ] || [ "$HTTP_CODE" = "409" ] || [ "$HTTP_CODE" = "429" ] || [[ "$HTTP_CODE" =~ ^5 ]]; then
              echo "Transient error ($HTTP_CODE). Sleeping ${backoff}s then retryingâ€¦"
              sleep "$backoff"
              backoff=$(( backoff * 2 ))
              attempt=$(( attempt + 1 ))
              continue
            fi

            # Hard failure: stop immediately
            echo "Hard failure $HTTP_CODE. Not retrying."
            exit 1
          done

          echo "Failed to publish after $max attempts."
          exit 1

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: place
          path: build/RobloxSoccer.rbxlx
