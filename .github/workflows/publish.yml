name: Publish

on:
  workflow_dispatch:
    inputs:
      channel:
        description: "dry or live"
        required: true
        default: "dry"
        type: choice
        options: [dry, live]
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ vars.PLACE_ID }}
  cancel-in-progress: false

jobs:
  publish:
    name: publish
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      ROBLOX_API_KEY: ${{ secrets.ROBLOX_API_KEY }}
      UNIVERSE_ID:    ${{ vars.UNIVERSE_ID }}
      PLACE_ID:       ${{ vars.PLACE_ID }}
      CHANNEL:        ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.channel || 'live' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          set -euxo pipefail
          sudo apt-get update -y
          sudo apt-get install -y curl unzip jq

      - name: Install Rojo (latest)
        run: |
          set -euxo pipefail
          V="7.6.1"
          curl -fsSL -o rojo.zip "https://github.com/rojo-rbx/rojo/releases/download/v${V}/rojo-${V}-linux-x86_64.zip"
          unzip -o rojo.zip
          sudo mv rojo /usr/local/bin/rojo
          rojo --version

      - name: Install rbxcloud (latest)
        run: |
          set -euxo pipefail
          curl -fsSL https://api.github.com/repos/Sleitnick/rbxcloud/releases/latest \
            | jq -r '.assets[] | select(.name|test("linux.*(x86_64|amd64).*(zip|tar\\.gz)$")) | .browser_download_url' \
            | head -n1 | xargs -I{} curl -fsSL -o rbxcloud.tgz {}
          tar -xzf rbxcloud.tgz || unzip -o rbxcloud.tgz || true
          BIN="$(find . -maxdepth 2 -type f -name rbxcloud | head -n1)"
          sudo mv "$BIN" /usr/local/bin/rbxcloud
          rbxcloud --version

      - name: Prepare build folder
        run: mkdir -p build

      - name: Build place
        run: rojo build -o build/RobloxSoccer.rbxlx

      - name: Sanity check (IDs only)
        run: |
          set -euxo pipefail
          test -n "${UNIVERSE_ID}"
          test -n "${PLACE_ID}"

      - name: Publish to Roblox (Open Cloud with retries)
        if: ${{ env.CHANNEL == 'live' || startsWith(github.ref, 'refs/tags/v') }}
        run: |
          set -u  # we handle errors manually (no -e)
          FILE="build/RobloxSoccer.rbxlx"

          attempt() {
            curl -sS -o /tmp/resp.json -w '%{http_code}' -X POST \
              -H "x-api-key: ${ROBLOX_API_KEY}" \
              -H "Accept: application/json" \
              -H "User-Agent: rbxcloud/ci" \
              -H "RBX-Source: GitHubActions" \
              -H "RBX-Client-Build: Rojo-CI" \
              -H "Content-Type: application/octet-stream" \
              --data-binary @"${FILE}" \
              "https://apis.roblox.com/universes/v1/${UNIVERSE_ID}/places/${PLACE_ID}/versions?versionType=Published&versionDescription=ci:${GITHUB_SHA::7},run:${GITHUB_RUN_ID}"
          }

          BACKOFF=(5 15 30 60 90 120 180 240 300 360 420 480)

          for i in $(seq 1 ${#BACKOFF[@]}); do
            echo "Attempt ${i}/${#BACKOFF[@]} …"
            CODE=$(attempt)
            echo "HTTP ${CODE}"
            cat /tmp/resp.json || true

            if [ "$CODE" = "200" ] || [ "$CODE" = "202" ]; then
              echo "✅ Publish accepted"
              exit 0
            fi

            if [ "$CODE" = "409" ] || [ "$CODE" = "000" ]; then
              echo "Transient (${CODE}). Backing off ${BACKOFF[$((i-1))]}s…"
              sleep "${BACKOFF[$((i-1))]}"
              continue
            fi

            echo "❌ Hard failure ${CODE}. Not retrying."
            exit 1
          done

          echo "❌ Exhausted retries."
          exit 1

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: place
          path: build/RobloxSoccer.rbxlx
